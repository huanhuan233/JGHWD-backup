# 软件文档

## 目录
1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [模块说明](#模块说明)
4. [操作指南](#操作指南)
5. [API接口文档](#api接口文档)
6. [部署说明](#部署说明)

---

## 项目概述

本项目是一个基于AI的智能文章生成系统，主要用于项目申报、技术文档等结构化文档的自动生成。系统通过大语言模型（LLM）结合知识库，能够根据用户提供的模板和标题自动生成高质量的文章内容。

### 主要功能
- **用户管理**：支持用户注册、登录、密码重置等功能
- **模板管理**：支持创建、编辑、导入文档模板（支持Word、PDF、TXT格式）
- **知识库配置**：支持配置Dify和FastGPT知识库，用于增强内容生成质量
- **大纲生成**：基于模板和AI模型自动生成文章大纲
- **内容生成**：根据大纲逐段生成文章正文内容
- **文档导出**：支持将生成的内容导出为Word文档（.docx格式）
- **SVG绘制**：提供SVG图形编辑功能

---

## 系统架构

### 技术栈
- **后端**：Django 4.2 + Django REST Framework
- **前端**：Vue 3 + Vite + Element Plus
- **数据库**：SQLite（开发环境）
- **AI模型**：支持多种大语言模型（通过SiliconFlow等平台调用）

### 目录结构
```
JGHWD/
├── backend/              # Django后端项目
│   ├── api/             # API模块
│   ├── users/           # 用户管理模块
│   ├── templates_config/ # 模板配置模块
│   ├── knowledge/       # 知识库配置模块
│   ├── outlines/       # 大纲管理模块
│   ├── contents/       # 内容生成模块
│   ├── headers/         # 页眉管理模块
│   ├── svgdraw/         # SVG绘制模块
│   ├── homepage/        # 首页模块
│   └── utils/           # 工具函数
├── web/                 # 前端项目
│   └── webfrontend/
│       └── frontend/    # Vue前端应用
└── docker/              # Docker配置
```

---

## 模块说明

### 1. 用户管理模块 (users)

#### 功能描述
提供用户注册、登录、密码管理等功能，支持管理员和普通用户两种角色。

#### 主要功能
- **用户注册**：新用户注册，需设置用户名、密码、密码提示问题
- **用户登录**：支持普通用户和管理员登录
- **密码重置**：支持通过提示问题重置密码
- **管理员功能**：管理员可以查看所有用户、重置用户密码

#### 数据模型
- `User`：用户模型，包含用户名、密码（加密存储）、提示问题等字段

#### 关键文件
- `backend/users/views.py`：用户相关视图函数
- `backend/users/models.py`：用户数据模型
- `backend/users/urls.py`：用户相关路由配置

---

### 2. 模板配置模块 (templates_config)

#### 功能描述
管理文档模板，支持从Word、PDF、TXT文件导入模板结构，或手动创建模板。

#### 主要功能
- **模板创建**：手动创建模板结构
- **模板导入**：从Word、PDF、TXT文件提取标题结构
- **模板保存**：保存模板到数据库（支持个人模板和公共模板）
- **模板列表**：查看所有可用模板

#### 支持的文件格式
- **Word文档** (.docx)：提取标题层级结构
- **PDF文档** (.pdf)：提取标题层级结构
- **文本文件** (.txt/.json)：直接导入JSON格式的模板结构

#### 关键文件
- `backend/templates_config/views.py`：模板管理视图
- `backend/templates_config/template.py`：模板解析和处理逻辑
- `backend/templates_config/models.py`：模板数据模型

#### 操作流程
1. 进入"格式管理"页面
2. 选择导入方式（上传文件或手动创建）
3. 如果上传文件，系统自动提取标题结构
4. 编辑模板结构（可添加、删除、修改节点）
5. 保存模板

---

### 3. 知识库配置模块 (knowledge)

#### 功能描述
配置和管理外部知识库（Dify、FastGPT），用于在内容生成时提供相关知识支持。

#### 主要功能
- **知识库配置**：添加、编辑、删除知识库配置
- **知识库类型**：支持Dify和FastGPT两种类型
- **知识检索**：在生成内容时自动检索相关知识

#### 配置参数
- **知识库名称**：自定义名称
- **知识库类型**：Dify 或 FastGPT
- **API密钥**：用于访问知识库的认证密钥

#### 关键文件
- `backend/knowledge/views.py`：知识库配置视图
- `backend/knowledge/models.py`：知识库配置数据模型
- `backend/knowledge/serializers.py`：知识库配置序列化器

#### 操作流程
1. 进入"知识库配置"页面
2. 点击"添加配置"
3. 填写知识库名称、类型、API密钥
4. 保存配置
5. 在生成内容时选择使用该知识库

---

### 4. 首页模块 (homepage)

#### 功能描述
提供文章生成的入口，用户在此选择模板、模型、知识库等参数，生成文章大纲。

#### 主要功能
- **模型列表**：显示可用的AI模型
- **模板列表**：显示可用的文档模板
- **大纲生成**：根据模板和参数生成文章大纲
- **知识库选择**：选择是否使用知识库增强生成

#### 关键文件
- `backend/homepage/views.py`：首页视图函数
- `backend/homepage/ai_model.py`：AI模型调用逻辑
- `backend/homepage/config.py`：模型配置

#### 操作流程
1. 进入首页
2. 输入文章标题
3. 选择模板（从模板列表中选择）
4. 选择AI模型
5. （可选）启用知识库并选择知识库配置
6. （可选）启用行文风格知识库
7. 点击"生成大纲"
8. 系统自动生成大纲并跳转到大纲编辑页面

---

### 5. 大纲管理模块 (outlines)

#### 功能描述
管理文章大纲，支持查看、编辑、删除大纲。

#### 主要功能
- **大纲列表**：查看所有大纲
- **大纲详情**：查看大纲的详细结构
- **大纲编辑**：编辑大纲标题和结构
- **大纲删除**：删除不需要的大纲

#### 数据模型
- `Outline`：大纲模型，包含标题、结构、模型名称等字段
- 结构格式：JSON数组，每个元素包含id、title、outline、content等字段

#### 关键文件
- `backend/outlines/views.py`：大纲管理视图
- `backend/outlines/models.py`：大纲数据模型
- `backend/outlines/serializers.py`：大纲序列化器

#### 操作流程
1. 在大纲编辑页面查看生成的大纲
2. 可以编辑各个小节的标题和概要
3. 保存修改
4. 跳转到内容生成页面

---

### 6. 内容生成模块 (contents)

#### 功能描述
根据大纲逐段生成文章正文内容，支持手动编辑和自动生成。

#### 主要功能
- **文章列表**：查看所有已生成的文章
- **内容生成**：为指定段落生成正文内容
- **内容编辑**：手动编辑段落内容
- **批量生成**：自动为所有段落生成内容
- **内容删除**：清空文章内容（保留大纲）
- **文档导出**：将生成的内容导出为Word文档

#### 生成参数
- **AI模型**：选择用于生成内容的模型
- **知识库**：选择是否使用知识库
- **行文风格**：选择行文风格知识库
- **自定义提示词**：添加自定义生成提示
- **最小字数**：设置生成内容的最小字数要求

#### 关键文件
- `backend/contents/views.py`：内容生成视图
- `backend/contents/ai_model.py`：AI模型调用逻辑
- `backend/contents/export.py`：文档导出功能
- `backend/utils/writer_utils.py`：提示词构建工具
- `backend/utils/content_utils.py`：内容提示词构建工具

#### 操作流程
1. 进入内容生成页面
2. 查看文章结构（从大纲继承）
3. 选择段落，点击"生成内容"
4. 设置生成参数（模型、知识库等）
5. 等待生成完成
6. 查看生成的内容，可手动编辑
7. 重复步骤3-6，为所有段落生成内容
8. 点击"导出文档"，下载Word文件

---

### 7. 文档导出模块 (contents/export)

#### 功能描述
将生成的文章内容导出为Word文档（.docx格式），支持自定义格式。

#### 主要功能
- **Markdown解析**：将Markdown格式的内容转换为Word格式
- **格式支持**：支持标题、段落、列表、表格、加粗、斜体等格式
- **样式配置**：支持设置字体、字号、行距等样式
- **页眉支持**：支持添加自定义页眉

#### 支持的Markdown元素
- 标题（H1-H6）
- 段落
- 无序列表和有序列表
- 表格
- 加粗和斜体
- 代码块
- 引用块

#### 关键文件
- `backend/contents/export.py`：文档导出核心逻辑
  - `OptimizedMarkdownParser`：Markdown解析器
  - `DocGenerator`：Word文档生成器

#### 导出参数
- **字体**：支持宋体、微软雅黑、黑体、Arial、Times New Roman
- **字号**：可设置正文字号
- **行距**：可设置行距倍数
- **页眉**：可选择页眉模板（默认信纸、公司红头、军工信纸）

---


### 9. SVG绘制模块 (svgdraw)

#### 功能描述
提供SVG图形编辑功能（具体功能待补充）。

#### 关键文件
- `backend/svgdraw/views.py`：SVG绘制视图
- `backend/svgdraw/models.py`：SVG数据模型

---

### 10. 工具模块 (utils)

#### 功能描述
提供通用的工具函数，用于内容生成和格式化。

#### 主要工具
- **writer_utils.py**：提供`build_prompt`函数，用于构建内容生成的提示词
- **content_utils.py**：提供`build_content_prompt`函数，用于构建内容扩写的提示词

#### 关键函数
- `build_prompt(article_title, section_title, kb_text, hw_text, prev_content)`：构建段落生成提示词
- `build_content_prompt(article_title, section_outline, kb_text, hw_text, min_words, prev_content, custom_prompt)`：构建内容扩写提示词

---

## 操作指南

### 1. 系统启动

#### 启动后端服务
```bash
cd /home/sysadmin/WorkSpace/PXY/JGHWD/backend
python manage.py runserver 0.0.0.0:8274
```

#### 启动前端服务
```bash
cd /home/sysadmin/WorkSpace/PXY/JGHWD/web/webfrontend/frontend
npm run dev
# 或使用PM2
pm2 start npx -- vite --host 0.0.0.0 --port 8273
```

#### 使用启动脚本
```bash
# 启动所有服务
./start_services.sh

# 停止所有服务
./stop_services.sh
```

### 2. 用户注册和登录

1. 访问前端页面（默认：http://localhost:8273）
2. 点击"注册"按钮
3. 填写用户名、密码、确认密码、密码提示问题和答案
4. 点击"注册"，系统返回Token
5. 使用Token进行后续API调用

### 3. 创建文档模板

#### 方式一：从文件导入
1. 进入"格式管理"页面
2. 点击"上传文件"
3. 选择Word、PDF或TXT文件
4. 系统自动提取标题结构
5. 编辑结构（可选）
6. 输入模板名称
7. 点击"保存"

#### 方式二：手动创建
1. 进入"格式管理"页面
2. 点击"新建模板"
3. 手动添加标题节点
4. 设置节点层级关系
5. 输入模板名称
6. 点击"保存"

### 4. 配置知识库

1. 进入"知识库配置"页面
2. 点击"添加配置"
3. 填写配置信息：
   - 知识库名称（自定义）
   - 知识库类型（Dify或FastGPT）
   - API密钥
4. 点击"保存"

### 5. 生成文章

#### 步骤1：生成大纲
1. 进入首页
2. 输入文章标题
3. 选择模板
4. 选择AI模型
5. （可选）启用知识库
6. 点击"生成大纲"
7. 等待生成完成，自动跳转到大纲编辑页面

#### 步骤2：编辑大纲
1. 在大纲编辑页面查看生成的大纲
2. 可以编辑各个小节的标题和概要
3. 点击"保存"
4. 点击"进入内容生成"跳转到内容生成页面

#### 步骤3：生成内容
1. 在内容生成页面查看文章结构
2. 选择要生成内容的段落
3. 点击"生成内容"按钮
4. 设置生成参数：
   - 选择AI模型
   - （可选）启用知识库
   - （可选）设置最小字数
   - （可选）添加自定义提示词
5. 点击"确认生成"
6. 等待生成完成
7. 查看生成的内容，可手动编辑
8. 重复步骤2-7，为所有段落生成内容

#### 步骤4：导出文档
1. 在内容生成页面，点击"导出文档"按钮
2. 设置导出参数：
   - 选择字体
   - 设置字号
   - 设置行距
   - 选择页眉（可选）
3. 点击"确认导出"
4. 等待导出完成，下载Word文档

### 6. 管理页眉

1. 进入页眉管理页面（通过API或后台）
2. 上传页眉文件（图片或Word文档）
3. 在导出文档时选择使用该页眉

---

## API接口文档

### 认证方式
所有需要认证的接口都使用Token认证，在请求头中添加：
```
Authorization: Token <your_token>
```

### 1. 用户管理接口

#### 用户注册
- **URL**: `/api/users/register/`
- **方法**: `POST`
- **请求体**:
```json
{
  "username": "用户名",
  "password": "密码",
  "confirm_password": "确认密码",
  "password_hint_question": "提示问题",
  "password_hint_answer": "提示答案"
}
```
- **响应**:
```json
{
  "success": true,
  "message": "注册成功",
  "user_id": 1,
  "token": "token_string"
}
```

#### 用户登录
- **URL**: `/api/users/login/`
- **方法**: `POST`
- **请求体**:
```json
{
  "username": "用户名",
  "password": "密码"
}
```
- **响应**:
```json
{
  "success": true,
  "message": "登录成功",
  "token": "token_string",
  "username": "用户名",
  "is_admin": false
}
```

### 2. 模板管理接口

#### 获取模板列表
- **URL**: `/api/list-templates?type=format`
- **方法**: `GET`
- **认证**: 需要Token
- **响应**: 返回模板列表

#### 保存模板
- **URL**: `/api/templates/save-template`
- **方法**: `POST`
- **认证**: 需要Token
- **请求体**:
```json
{
  "id": "模板ID",
  "name": "模板名称",
  "structure": [...],
  "is_public": false
}
```

#### 删除模板
- **URL**: `/api/templates/delete-template`
- **方法**: `POST`
- **认证**: 需要Token
- **请求体**:
```json
{
  "id": "模板ID"
}
```

### 3. 知识库配置接口

#### 获取知识库配置列表
- **URL**: `/api/knowledge/configs/`
- **方法**: `GET`
- **认证**: 需要Token
- **响应**: 返回配置列表

#### 保存知识库配置
- **URL**: `/api/knowledge/save-config`
- **方法**: `POST`
- **认证**: 需要Token
- **请求体**:
```json
{
  "name": "配置名称",
  "type": "dify" | "FastGpt",
  "api_key": "API密钥"
}
```

#### 删除知识库配置
- **URL**: `/api/knowledge/configs/?id=<config_id>`
- **方法**: `DELETE`
- **认证**: 需要Token

### 4. 大纲生成接口

#### 生成大纲
- **URL**: `/api/generate-outline-items/`
- **方法**: `POST`
- **认证**: 需要Token
- **请求体**:
```json
{
  "model": "模型名称",
  "titles": ["标题1", "标题2", ...],
  "article_title": "文章标题",
  "title_setting": {...},
  "use_kb": true,
  "knowledge": "知识库名称",
  "use_hw": true,
  "hw_knowledge": "行文风格知识库名称"
}
```
- **响应**:
```json
{
  "success": true,
  "outline": {
    "id": 1,
    "title": "文章标题",
    "structure": [...]
  }
}
```

#### 获取大纲列表
- **URL**: `/api/outlines/`
- **方法**: `GET`
- **认证**: 需要Token
- **响应**: 返回大纲列表

#### 获取大纲详情
- **URL**: `/api/outlines/<id>/`
- **方法**: `GET`
- **认证**: 需要Token

#### 删除大纲
- **URL**: `/api/outlines/<id>/`
- **方法**: `DELETE`
- **认证**: 需要Token

### 5. 内容生成接口

#### 获取文章列表
- **URL**: `/api/contents/articles/`
- **方法**: `GET`
- **认证**: 需要Token
- **响应**: 返回文章列表

#### 生成内容
- **URL**: `/api/contents/auto-generate/`
- **方法**: `POST`
- **认证**: 需要Token
- **请求体**:
```json
{
  "outline_id": 1,
  "section_id": "s1",
  "model": "模型名称",
  "article_title": "文章标题",
  "section_title": "小节标题",
  "section_outline": "小节概要",
  "use_kb": true,
  "knowledge_config_id": "知识库名称",
  "use_hw": true,
  "hw_knowledge": "行文风格知识库名称",
  "min_words": "500",
  "custom_prompt": "自定义提示词"
}
```

#### 更新段落内容
- **URL**: `/api/contents/articles/<outline_id>/sections/<section_id>/`
- **方法**: `PATCH`
- **认证**: 需要Token
- **请求体**:
```json
{
  "content": "新的内容"
}
```

#### 删除文章内容
- **URL**: `/api/contents/delete_content/<article_id>`
- **方法**: `GET`
- **认证**: 需要Token

#### 导出文档
- **URL**: `/api/contents/export/`
- **方法**: `POST`
- **认证**: 需要Token
- **请求体**:
```json
{
  "outline_id": 1,
  "font": "宋体",
  "font_size": 12,
  "line_spacing": 1.5,
  "header": "默认信纸"
}
```
- **响应**: 返回Word文档文件

### 6. 页眉管理接口

#### 上传页眉
- **URL**: `/api/headers/upload/`
- **方法**: `POST`
- **认证**: 需要Token
- **请求**: multipart/form-data，包含file字段

#### 获取页眉列表
- **URL**: `/api/headers/list/`
- **方法**: `GET`
- **认证**: 需要Token

#### 删除页眉
- **URL**: `/api/headers/delete/<id>/`
- **方法**: `DELETE`
- **认证**: 需要Token

---

## 部署说明

### 环境要求
- Python 3.8+
- Node.js 16+
- Django 4.2
- Vue 3

### 后端部署

1. **安装依赖**
```bash
cd backend
pip install -r requirements.txt
```

2. **数据库迁移**
```bash
python manage.py migrate
```

3. **创建超级用户（可选）**
```bash
python manage.py createsuperuser
```

4. **启动服务**
```bash
python manage.py runserver 0.0.0.0:8274
```

### 前端部署

1. **安装依赖**
```bash
cd web/webfrontend/frontend
npm install
```

2. **开发环境启动**
```bash
npm run dev
```

3. **生产环境构建**
```bash
npm run build
```

### 使用启动脚本

项目提供了便捷的启动脚本：

```bash
# 启动所有服务
./start_services.sh

# 停止所有服务
./stop_services.sh
```

### 配置说明

#### 后端配置
- 后端服务端口：8274（可在`start_services.sh`中修改）
- 数据库：SQLite（开发环境），生产环境建议使用PostgreSQL或MySQL
- 静态文件：配置在`backend/backend/settings.py`中

#### 前端配置
- 前端服务端口：8273（可在`start_services.sh`中修改）
- API基础URL：在`web/webfrontend/frontend/src/api/index.ts`中配置

#### 环境变量
- 创建`.env`文件配置敏感信息（API密钥等）
- 使用`python-dotenv`加载环境变量

---

## 常见问题

### 1. 如何重置管理员密码？
管理员密码硬编码在`backend/users/views.py`中，默认用户名：`Admin`，密码：`Root1234`。

### 2. 如何添加新的AI模型？
在`backend/homepage/config.py`和`backend/contents/config.py`中的`MODEL_CHOICES`列表中添加新模型。

### 3. 如何配置知识库？
1. 进入"知识库配置"页面
2. 添加配置，填写API密钥
3. 确保知识库服务可访问（Dify或FastGPT）

### 4. 导出文档格式不正确？
检查Markdown格式是否符合规范，特别是表格格式。

### 5. 编辑内容后导出文档，修改的内容没有保存？
**问题描述**：在正文生成页面编辑内容后，点击"生成文档"下载的文档中，修改的内容没有被保存。

**解决方案**：
- 系统已自动修复此问题。现在导出文档时会自动从数据库读取最新内容。
- 编辑内容时，系统会在您结束编辑（双击退出编辑模式）时自动保存。
- 点击"生成文档"前，系统会先保存所有正在编辑的内容，然后从数据库读取最新数据生成文档。

**操作建议**：
- 编辑完内容后，双击文本区域退出编辑模式，系统会自动保存。
- 如果正在编辑时点击"生成文档"，系统会先保存再导出，确保导出的是最新内容。

### 6. 如何备份数据？
SQLite数据库文件位于`backend/db.sqlite3`，直接复制该文件即可。

---

## 更新日志

### 版本信息
- 当前版本：1.0.0
- 最后更新：2024年

### 主要功能
- ✅ 用户注册和登录
- ✅ 模板管理（支持Word、PDF、TXT导入）
- ✅ 知识库配置（支持Dify和FastGPT）
- ✅ AI驱动的大纲生成
- ✅ AI驱动的内容生成
- ✅ Word文档导出
- ✅ SVG绘制功能

---

## 技术支持

如有问题，请联系开发团队或查看项目文档。

---

*文档最后更新时间：2024年*

